name: Build OpenSSL 3.x

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenSSL Version (e.g. 3.3.0)'
        required: true
        default: '3.3.0'

jobs:
  build:
    name: ${{ matrix.os-label }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os-runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- DESKTOP WINDOWS ---
          - os-label: Windows
            os-runner: windows-latest
            arch: x64
            target: VC-WIN64A
            setup_cmd: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          - os-label: Windows
            os-runner: windows-latest
            arch: x86
            target: VC-WIN32
            setup_cmd: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
          - os-label: Windows
            os-runner: windows-latest
            arch: arm64
            target: VC-WIN64-ARM
            setup_cmd: call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsamd64_arm64.bat"

          # --- DESKTOP LINUX ---
          - os-label: Linux
            os-runner: ubuntu-latest
            arch: x64
            target: linux-x86_64
            setup_cmd: sudo apt-get update && sudo apt-get install -y build-essential
          - os-label: Linux
            os-runner: ubuntu-latest
            arch: arm64
            target: linux-aarch64
            cross_compile_prefix: aarch64-linux-gnu-
            setup_cmd: sudo apt-get update && sudo apt-get install -y build-essential gcc-aarch64-linux-gnu

          # --- DESKTOP MACOS ---
          - os-label: macOS
            os-runner: macos-14
            arch: x64
            target: darwin64-x86_64-cc
            setup_cmd: echo "Setup Mac Intel"
          - os-label: macOS
            os-runner: macos-14
            arch: arm64
            target: darwin64-arm64-cc
            setup_cmd: echo "Setup Mac ARM"

          # --- ANDROID (Linux Host) ---
          - os-label: Android
            os-runner: ubuntu-latest
            arch: arm64
            target: android-arm64
            ndk_ver: 26.1.10909125
          - os-label: Android
            os-runner: ubuntu-latest
            arch: arm
            target: android-arm
            ndk_ver: 26.1.10909125
          - os-label: Android
            os-runner: ubuntu-latest
            arch: x86
            target: android-x86
            ndk_ver: 26.1.10909125
          - os-label: Android
            os-runner: ubuntu-latest
            arch: x64
            target: android-x86_64
            ndk_ver: 26.1.10909125

          # --- IOS (macOS Host) ---
          # Static Only
          - os-label: iOS
            os-runner: macos-14
            arch: arm64
            target: ios64-cross
            static_only: true
          - os-label: iOS_Sim
            os-runner: macos-14
            arch: x64
            target: iossimulator-xcrun
            static_only: true

    steps:
      - name: Checkout Builder Repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # ENVIRONMENT SETUP
      # ------------------------------------------------------------------------
      
      - name: Remove GNU Link (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          if exist "C:\Program Files\Git\usr\bin\link.exe" del "C:\Program Files\Git\usr\bin\link.exe"
      
      - name: Setup Linux Deps
        if: runner.os == 'Linux' && matrix.os-label == 'Linux'
        run: ${{ matrix.setup_cmd }}

      - name: Setup Android NDK
        if: matrix.os-label == 'Android'
        run: |
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Download OpenSSL Source
        run: |
          curl -L -o openssl.tar.gz https://github.com/openssl/openssl/releases/download/openssl-${{ github.event.inputs.version }}/openssl-${{ github.event.inputs.version }}.tar.gz
          tar -xzf openssl.tar.gz
          mv openssl-${{ github.event.inputs.version }} src

      # ------------------------------------------------------------------------
      # BUILD SHARED (Skip for iOS/StaticOnly)
      # ------------------------------------------------------------------------
      
      - name: Configure Shared (Windows)
        if: runner.os == 'Windows' && matrix.static_only != true
        working-directory: src
        shell: cmd
        run: |
          ${{ matrix.setup_cmd }}
          perl Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/shared shared no-tests "CFLAGS=/nologo /O2 /MT"
      
      - name: Configure Shared (Unix/Android)
        if: runner.os != 'Windows' && matrix.static_only != true
        working-directory: src
        env:
          CROSS_COMPILE: ${{ matrix.cross_compile_prefix }}
        run: |
          # 1. Define Standard Paths
          OPENSSLDIR="/usr/lib/ssl"
          PREFIX="/usr/local"
          
          # Linux Specifics: Use $ORIGIN for relative loading
          LDFLAGS=""
          if [ "${{ runner.os }}" == "Linux" ]; then
             LDFLAGS="-Wl,-rpath,\$$ORIGIN"
          fi
          
          if [ "${{ runner.os }}" == "macOS" ]; then
             OPENSSLDIR="/private/etc/ssl"
          fi
          
          # 2. Configure
          ./Configure ${{ matrix.target }} \
            --prefix=$PREFIX \
            --openssldir=$OPENSSLDIR \
            shared no-tests \
            $LDFLAGS
                
      - name: Build Shared (Windows)
        if: runner.os == 'Windows' && matrix.static_only != true
        working-directory: src
        shell: cmd
        run: |
          ${{ matrix.setup_cmd }}
          nmake
          nmake install
          nmake install_html_docs || echo "Docs generation failed"          
      
      - name: Build Shared (Unix/Android)
        if: runner.os != 'Windows' && matrix.static_only != true
        working-directory: src
        env:
          CROSS_COMPILE: ${{ matrix.cross_compile_prefix }}
        run: |
          make -j4
          
          # 1. Install to Staging Area
          STAGING_DIR="_staging"
          make install_sw DESTDIR=$(pwd)/$STAGING_DIR
          
          # 2. Move to Expected Output Directory (dist/shared)
          mkdir -p ../dist/shared
          cp -r $STAGING_DIR/usr/local/* ../dist/shared/
          
          # 3. Docs
          make install_html_docs DESTDIR=$(pwd)/$STAGING_DIR || echo "Docs generation failed"          
          if [ -d "$STAGING_DIR/usr/local/html" ]; then
             mkdir -p ../dist/shared/html
             cp -r $STAGING_DIR/usr/local/html/* ../dist/shared/html/
          fi
          if [ -d "$STAGING_DIR/usr/local/share/doc" ]; then
             mkdir -p ../dist/shared/share/doc
             cp -r $STAGING_DIR/usr/local/share/doc/* ../dist/shared/share/doc/
          fi
          
      # ------------------------------------------------------------------------
      # BUILD STATIC
      # ------------------------------------------------------------------------

      - name: Clean Source (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        shell: cmd
        run: |
          ${{ matrix.setup_cmd }}
          nmake clean

      - name: Clean Source (Unix)
        if: runner.os != 'Windows' && matrix.static_only != true
        working-directory: src
        env:
          CROSS_COMPILE: ${{ matrix.cross_compile_prefix }}
        run: make clean

      - name: Configure Static (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        shell: cmd
        run: |
          ${{ matrix.setup_cmd }}
          perl Configure ${{ matrix.target }} --prefix=${{ github.workspace }}/dist/static no-shared no-tests "CFLAGS=/nologo /O2 /MT"
      
      - name: Configure Static (Unix/Android/iOS)
        if: runner.os != 'Windows'
        working-directory: src
        env:
          CROSS_COMPILE: ${{ matrix.cross_compile_prefix }}
        run: |
          # 1. Define Standard Paths
          OPENSSLDIR="/usr/lib/ssl"
          PREFIX="/usr/local"
          
          if [ "${{ runner.os }}" == "macOS" ]; then
             OPENSSLDIR="/private/etc/ssl"
          fi

          # 2. iOS Specifics
          EXTRA_FLAGS=""
          if [ "${{ matrix.target }}" == "ios64-cross" ]; then
             SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
             export CC=clang
             # Construct the CFLAGS argument
             EXTRA_FLAGS="CFLAGS=-isysroot ${SDK_PATH} -arch arm64"
             unset CROSS_TOP
             unset CROSS_SDK
          fi

          # 3. Configure
          # Fix: Use ${VAR:+"$VAR"} to avoid passing an empty string argument
          ./Configure ${{ matrix.target }} \
             --prefix=$PREFIX \
             --openssldir=$OPENSSLDIR \
             no-shared no-tests \
             ${EXTRA_FLAGS:+"$EXTRA_FLAGS"}

      - name: Build Static (Windows)
        if: runner.os == 'Windows'
        working-directory: src
        shell: cmd
        run: |
          ${{ matrix.setup_cmd }}
          nmake
          nmake install

      - name: Build Static (Unix/Android/iOS)
        if: runner.os != 'Windows'
        working-directory: src
        env:
          CROSS_COMPILE: ${{ matrix.cross_compile_prefix }}
        run: |
          make -j4
          
          # 1. Install to Staging Area
          STAGING_DIR="_staging_static"
          make install_sw DESTDIR=$(pwd)/$STAGING_DIR
          
          # 2. Move to Expected Output Directory (dist/static)
          mkdir -p ../dist/static
          cp -r $STAGING_DIR/usr/local/* ../dist/static/
          
      # ------------------------------------------------------------------------
      # REARRANGE ARTIFACTS
      # ------------------------------------------------------------------------
      - name: Rearrange Output
        shell: bash
        run: |
          # 1. Create Staging Areas
          mkdir -p dist/runtime
          mkdir -p dist/dev/bin
          mkdir -p dist/dev/lib
          mkdir -p dist/dev/include
          mkdir -p dist/dev/doc
          mkdir -p dist/dev/debug
          
          cp src/LICENSE.txt dist/runtime/
          cp src/LICENSE.txt dist/dev/
          
          # 2. Populate Dev Headers & Docs
          if [ -d "dist/shared/include" ]; then
             cp -r dist/shared/include/* dist/dev/include/
          else
             cp -r dist/static/include/* dist/dev/include/
          fi

          if [ -d "dist/shared/html" ]; then
            cp -r dist/shared/html/* dist/dev/doc/
          elif [ -d "dist/shared/share/doc" ]; then
             cp -r dist/shared/share/doc/* dist/dev/doc/
          elif [ -d "dist/static/html" ]; then
             cp -r dist/static/html/* dist/dev/doc/
          elif [ -d "dist/static/share/doc" ]; then
             cp -r dist/static/share/doc/* dist/dev/doc/
          fi

          # 3. Populate Static Libs (Dev Only)
          if [ "${{ runner.os }}" == "Windows" ]; then
             cp dist/static/lib/*.lib dist/dev/lib/
          else
             cp dist/static/lib/*.a dist/dev/lib/ 2>/dev/null || cp dist/static/lib64/*.a dist/dev/lib/
          fi

          # 4. Populate Shared Binaries (Runtime + Dev)
          if [ "${{ matrix.static_only }}" != "true" ]; then
          
            # --- WINDOWS ---
            if [ "${{ runner.os }}" == "Windows" ]; then
               # Runtime (Flat, No PDBs)
               cp dist/shared/bin/*.dll dist/runtime/
               cp dist/shared/bin/*.exe dist/runtime/
               
               # Dev (Structured, With PDBs)
               cp dist/shared/bin/*.dll dist/dev/bin/
               cp dist/shared/bin/*.exe dist/dev/bin/
               cp dist/shared/bin/*.pdb dist/dev/debug/ 2>/dev/null || true
               
               # Providers/Engines Logic
               mkdir -p dist/runtime/providers dist/runtime/engines
               mkdir -p dist/dev/bin/providers dist/dev/bin/engines
               
               find dist/shared/lib -name "*.dll" | while read file; do
                   if [[ "$file" == *"ossl-modules"* ]]; then
                       cp "$file" dist/runtime/providers/
                       cp "$file" dist/dev/bin/providers/
                       pdb="${file%.dll}.pdb"
                       if [ -f "$pdb" ]; then cp "$pdb" dist/dev/bin/providers/; fi
                   elif [[ "$file" == *"engines"* ]]; then
                       cp "$file" dist/runtime/engines/
                       cp "$file" dist/dev/bin/engines/
                       pdb="${file%.dll}.pdb"
                       if [ -f "$pdb" ]; then cp "$pdb" dist/dev/bin/engines/; fi
                   fi
               done
               find dist/shared/lib -name "*.pdb" -exec cp {} dist/dev/debug/ \;

            # --- UNIX (Linux/macOS/Android) ---
            else
               # A. Copy to Dev (Keep symbols / Original state)
               find dist/shared -type f \( -name "libcrypto*.so*" -o -name "libssl*.so*" -o -name "libcrypto*.dylib" -o -name "libssl*.dylib" \) -exec cp -L {} dist/dev/bin/ \;
               
               if [ -f "dist/shared/bin/openssl" ]; then
                 cp dist/shared/bin/openssl dist/dev/bin/
               fi

               mkdir -p dist/dev/bin/providers dist/dev/bin/engines
               find dist/shared -path "*/ossl-modules/*" \( -name "*.so" -o -name "*.dylib" \) -exec cp -L {} dist/dev/bin/providers/ \;
               find dist/shared -path "*/engines-3/*" \( -name "*.so" -o -name "*.dylib" \) -exec cp -L {} dist/dev/bin/engines/ \;

               # B. Copy Dev to Runtime
               cp -r dist/dev/bin/* dist/runtime/
               if [ -d "dist/runtime/providers" ]; then mv dist/runtime/providers/* dist/runtime/providers/ 2>/dev/null || true; fi
               
               # C. Determine Strip Tool & Flags
               STRIP_BIN="strip"
               STRIP_FLAGS="-s" 

               if [ "${{ matrix.os-label }}" == "Android" ]; then
                  STRIP_BIN="llvm-strip"
                  STRIP_FLAGS="--strip-unneeded"
               elif [ "${{ matrix.arch }}" == "arm64" ] && [ "${{ runner.os }}" == "Linux" ]; then
                  STRIP_BIN="${{ matrix.cross_compile_prefix }}strip"
                  STRIP_FLAGS="--strip-unneeded"
               elif [ "${{ runner.os }}" == "macOS" ]; then
                  STRIP_BIN="strip"
                  STRIP_FLAGS="-x"
               fi

               echo "Stripping Runtime binaries using: $STRIP_BIN $STRIP_FLAGS"

               # D. Execute Strip on Runtime folder
               chmod -R u+w dist/runtime
               find dist/runtime -type f \( -name "*.so*" -o -name "*.dylib" -o -name "openssl" \) -print0 | xargs -0 -I {} $STRIP_BIN $STRIP_FLAGS {}
               
               # E. macOS Specifics (dSYM & Relocatability)
               if [ "${{ runner.os }}" == "macOS" ]; then
                  # dSYM for Dev
                  for lib in dist/dev/bin/*.dylib dist/dev/bin/providers/*.dylib dist/dev/bin/engines/*.dylib; do
                     if [ -f "$lib" ] && [ ! -L "$lib" ]; then
                        dsymutil "$lib" -o "$lib.dSYM"
                        mv "$lib.dSYM" dist/dev/debug/
                        strip -x "$lib"
                     fi
                  done
                  
                  # Relocatability (install_name_tool) for Runtime
                  echo "Making macOS binaries relocatable..."
                  OLD_PATH="/usr/local/lib" # Matches our Configure --prefix
                  
                  # Fix IDs
                  for lib in dist/runtime/lib*.dylib; do
                     if [ -f "$lib" ] && [ ! -L "$lib" ]; then
                        LIB_NAME=$(basename "$lib")
                        install_name_tool -id "@rpath/$LIB_NAME" "$lib"
                     fi
                  done
                  
                  # Fix Dependencies
                  TARGETS=$(find dist/runtime -maxdepth 1 -type f \( -name "*.dylib" -o -name "openssl" \))
                  for target in $TARGETS; do
                     # Note: OpenSSL 3.x with --prefix might link to /usr/local/lib or /usr/local/lib64 depending on config
                     # We loosely grep for the lib name to be safe
                     otool -L "$target" | grep "libcrypto\|libssl" | grep -v "@rpath" | awk '{print $1}' | while read dep; do
                        DEP_NAME=$(basename "$dep")
                        install_name_tool -change "$dep" "@loader_path/$DEP_NAME" "$target"
                     done
                     install_name_tool -add_rpath "@executable_path" "$target" 2>/dev/null || true
                  done
               fi
            fi
          fi

          # 5. Cleanup Empty Directories
          find dist -type d -empty -delete

      # ------------------------------------------------------------------------
      # SMOKE TEST (Verify Relocatable Binaries)
      # ------------------------------------------------------------------------
      - name: Smoke Test
        if: matrix.static_only != true
        shell: bash
        run: |
          echo "=== Starting Smoke Test ==="
          
          # 1. Define Paths
          RUNTIME_DIR="${{ github.workspace }}/dist/runtime"
          
          if [ "${{ runner.os }}" == "Windows" ]; then
             EXE="$RUNTIME_DIR/openssl.exe"
          else
             EXE="$RUNTIME_DIR/openssl"
             # Force loader to look in runtime dir first
             export LD_LIBRARY_PATH="$RUNTIME_DIR:$LD_LIBRARY_PATH"
             export DYLD_LIBRARY_PATH="$RUNTIME_DIR:$DYLD_LIBRARY_PATH"
          fi

          if [ ! -f "$EXE" ]; then
             echo "Error: Executable not found at $EXE"
             exit 1
          fi

          # 2. Check if we can execute on this runner
          SHOULD_RUN=false

          if [ "${{ matrix.os-label }}" == "Android" ]; then
             echo "Skipping: Cannot run Android binaries on Ubuntu host."
          elif [ "${{ matrix.os-label }}" == "iOS" ]; then
             echo "Skipping: Cannot run iOS binaries."
          elif [ "${{ runner.os }}" == "Linux" ] && [ "${{ matrix.arch }}" != "x64" ]; then
             echo "Skipping: Cannot run ${{ matrix.arch }} binaries on x64 Linux host."
          elif [ "${{ runner.os }}" == "Windows" ] && [ "${{ matrix.arch }}" == "arm64" ]; then
             echo "Skipping: Cannot run Windows ARM64 binaries on x64 Windows host."
          else
             # Valid: Win x64/x86, Linux x64, macOS x64/ARM64
             SHOULD_RUN=true
          fi

          # 3. Execute
          if [ "$SHOULD_RUN" == "true" ]; then
             echo "Attempting to run: $EXE version -a"
             
             chmod +x $EXE
             $EXE version -a
             
             echo ">>> SUCCESS: Binary loaded and ran."
          fi

      # ------------------------------------------------------------------------
      # PACKAGING
      # ------------------------------------------------------------------------
      
      - name: Pack Runtime
        if: matrix.static_only != true
        working-directory: dist/runtime
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
             7z a "${{ github.workspace }}/openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}.zip" .
          else
             tar -czvf "${{ github.workspace }}/openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}.tar.gz" .
          fi
        shell: bash

      - name: Pack Dev
        working-directory: dist/dev
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
             7z a "${{ github.workspace }}/openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}-dev.zip" .
          else
             tar -czvf "${{ github.workspace }}/openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}-dev.tar.gz" .
          fi
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ github.event.inputs.version }}-${{ matrix.os-label }}-${{ matrix.arch }}
          compression-level: 0 
          path: |
            ${{ github.workspace }}/openssl-*.zip
            ${{ github.workspace }}/openssl-*.tar.gz
          retention-days: 15 
          if-no-files-found: warn